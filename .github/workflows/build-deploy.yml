name: Build and Deploy Mikro ERP Documentation

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: |
        npm install --only=dev
        echo "Dependencies installed successfully"

    - name: ğŸ—ï¸ Run Build Process
      run: |
        echo "Starting build process..."
        node build.js
        echo "Build completed successfully"
      env:
        NODE_ENV: production
        BUILD_NUMBER: ${{ github.run_number }}

    - name: ğŸ” Validate Build
      run: |
        echo "Validating build output..."
        ls -la dist/
        echo "Checking required files..."
        test -f dist/index.html || (echo "Missing index.html" && exit 1)
        test -f dist/sitemap.xml || (echo "Missing sitemap.xml" && exit 1)
        test -f dist/robots.txt || (echo "Missing robots.txt" && exit 1)
        test -f dist/build-info.json || (echo "Missing build-info.json" && exit 1)
        echo "All files validated successfully"

    - name: ğŸ“Š Build Statistics
      run: |
        echo "ğŸ“Š Build Statistics:"
        echo "Build Number: ${{ github.run_number }}"
        echo "Git SHA: ${{ github.sha }}"
        echo "Build Date: $(date)"
        echo ""
        echo "ğŸ“ File Counts:"
        echo "Total files: $(find dist/ -type f | wc -l)"
        echo "HTML files: $(find dist/ -name '*.html' | wc -l)"
        echo "CSS files: $(find dist/ -name '*.css' | wc -l)"
        echo ""
        echo "ğŸ“¦ Directory Sizes:"
        du -sh dist/ || echo "Size calculation not available"
        echo ""
        echo "ğŸ—ï¸ Build Info:"
        cat dist/build-info.json || echo "Build info not available"

    - name: ğŸ“„ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ—‚ï¸ Upload Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: âœ… Deployment Success
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“ Build completed at: $(date)"
        
        # Build baÅŸarÄ± durumunu kaydet
        echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
        echo "DEPLOYMENT_URL=${{ steps.deployment.outputs.page_url }}" >> $GITHUB_OUTPUT

  notify:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¢ Build Status Notification
      run: |
        if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
          echo "âœ… Build ve deployment baÅŸarÄ±lÄ±!"
          echo "ğŸŒ Site: https://tansuozcelebi.github.io/MikroERPTablo/"
        else
          echo "âŒ Build veya deployment baÅŸarÄ±sÄ±z!"
          echo "âš ï¸ LÃ¼tfen loglarÄ± kontrol edin."
        fi